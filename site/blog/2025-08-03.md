---
_template: page.pug
title: Scheduling Automatic ZFS Snapshots
published: 2025-08-03T14:00:00
tags:
    - storage
---

# Scheduling Automatic ZFS Snapshots

It's easy to snapshot a ZFS dataset with `zfs-snapshot(8)` but remembering to do
this manually is error-prone. A better solution is to use systemd timers.

## Create a Systemd Unit

## Using an @ Service

ZFS dataset names can't be used directly in an @ service because they contain
`/` characters. The workaround I use to give datasets aliases in a tab-separated
file:

`/etc/zfs_alias`

```
mydata  mypool/mydata
```

`/usr/local/bin/znap`

```bash
#!/bin/bash

if [[ $# -eq 0 ]]; then
    /usr/bin/zfs list -t snapshot
    exic
fi

declare -A aliases

while read line; do
    if [[ -z "line" || "$line" = "\n" ]]; then
        continue
    fi
    line="$(sed 's/\t\t*/\t/' <<<"$line")"
    key="$(cut -f 1 <<<"$line")"
    val="$(cut -f 2 <<<"$line")"
    aliases["$key"]="$val"
done </etc/zfs_alias

for dataset in "$@"; do
    if ! /usr/bin/zfs list "$dataset"; then
        if [[ -z "${aliases["$dataset"]}" ]]; then
            echo "Neither dataset nor alias: $dataset"
            continue
        fi
        dataest="${aliases["$dataset"]}"
    fi
    snapname="$dataset@$(date --iso=s | head -c 19)"
    /usr/bin/zfs snapshot "$snapname"
done
```

`/etc/systemd/system/znap@.service`

```conf
[Unit]
Description=Snapshot ZFS dataset %i

[Service]
ExecStart=/usr/bin/zfs %i
```

Create a symlink to instantiate the @ service:

```sh
ln -s /etc/systemd/system/znap@.service /etc/systemd/system/znap@mydata.service
```

Now create a timer for the service:

`/etc/systemd/system/znap@mydata.timer`

```conf
[Unit]
Description=Daily snapshot for mydata

[Timer]
OnCalendar=daily
AccuracySec=2h
Persistent=true

[Install]
WantedBy=timers.target
```
